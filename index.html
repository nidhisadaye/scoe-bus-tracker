<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCOE Bus MVP</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f4f7f6; }
        header { background: #003366; color: white; padding: 1rem; text-align: center; font-weight: bold; }
        
        /* The Map must have a fixed height or it will be invisible */
        #map { height: 450px; width: 100%; border-bottom: 3px solid #003366; }
        
        .container { padding: 15px; }
        .card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .status-badge { padding: 5px 10px; border-radius: 5px; font-weight: bold; color: white; background: #28a745; }
        .btn { padding: 12px; border: none; border-radius: 5px; cursor: pointer; color: white; font-weight: bold; margin-right: 5px; }
        .btn-green { background: #28a745; }
        .btn-red { background: #dc3545; }
        h3 { margin-top: 0; color: #333; }
    </style>
</head>
<body>

<header>Saraswati College Bus Tracker</header>

<div id="map"></div>

<div class="container">
    <div class="card">
        <h3>Live Bus Info</h3>
        <p>Current Status: <span id="crowd-status" class="status-badge">Checking...</span></p>
        <p id="distance-info">Connecting to GPS...</p>
    </div>

    <div class="card" style="background: #eef2f3;">
        <h3>Driver/Testing Controls</h3>
        <p>Update crowd status for students:</p>
        <button class="btn btn-green" onclick="setCrowd('Seats Available')">Seats Available</button>
        <button class="btn btn-red" onclick="setCrowd('Bus Full')">Bus Full</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // --- STEP A: CONFIGURATION ---
    const firebaseConfig = {
         apiKey: "AIzaSyCjuaSkiA0sONC6YHc0E8cmV52QtGUzrNg",
  authDomain: "scoe-bus.firebaseapp.com",
  databaseURL: "https://scoe-bus-default-rtdb.firebaseio.com",
  projectId: "scoe-bus",
  storageBucket: "scoe-bus.firebasestorage.app",
  messagingSenderId: "878739424900",
  appId: "1:878739424900:web:20cd52d982b0c82402a4d1",
  measurementId: "G-HS55K015G4"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const busId = "Bus_01_Kharghar";
    const scoeCoords = [19.0437, 73.0675]; // SCOE College Location

    let map, busMarker;

    // --- STEP B: MAP INITIALIZATION ---
    function initMap() {
        // This centers the camera on SCOE when the page first loads
         map = L.map('map').setView([19.0437, 73.0675], 15);

        // Add OpenStreetMap layer (The free skin)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // Add a red marker for the bus
        busMarker = L.marker(scoeCoords).addTo(map)
            .bindPopup("SCOE College Bus")
            .openPopup();

        startAppLogic();
    }

    // --- STEP C: CORE LOGIC ---
    function startAppLogic() {
       /*// 1. WATCH GPS (If you are the driver)
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(position => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
        

                // Send current location to Firebase
                database.ref('buses/' + busId + '/location').set({ lat, lng });
            }, err => console.error("GPS Error: ", err), { enableHighAccuracy: true });
        }
        */
        // 2. LISTEN FOR UPDATES (Student View)
        // Listen for location changes
        database.ref('buses/' + busId + '/location').on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                const newPos = [data.lat, data.lng];
                busMarker.setLatLng(newPos);
                
                // Calculate distance to college
                const dist = getDistance(data.lat, data.lng, scoeCoords[0], scoeCoords[1]);
                document.getElementById('distance-info').innerText = `Bus is ${dist.toFixed(2)} km from SCOE Campus`;
            }
        });

        // Listen for crowd status changes
        database.ref('buses/' + busId + '/status').on('value', (snapshot) => {
            const status = snapshot.val();
            if (status) {
                const badge = document.getElementById('crowd-status');
                badge.innerText = status;
                badge.style.background = status === 'Bus Full' ? '#dc3545' : '#28a745';
            }
        });
    }

    // --- STEP D: HELPER FUNCTIONS ---
    function setCrowd(val) {
        database.ref('buses/' + busId + '/status').set(val);
    }

    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // Earth radius in km
        const dLat = (lat2-lat1) * Math.PI / 180;
        const dLon = (lon2-lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2);
        return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }

    // Run map setup when page loads
    window.onload = initMap;
</script>

</body>
</html>